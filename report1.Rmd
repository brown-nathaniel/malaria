---
title: "report1"
author: "Nathaniel Brown, Huijia Yu, Angie Shen"
date: "November 6, 2017"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)
library(reshape2)
library(ggplot2)
library(dplyr)
library(mice)
library(VIM)
```

# Introduction

We are interested in predicting whether malaria parasites will be found in a child's blood based on his/her age, bednet use, greenery in his/her village, and presence of a health clinic. However, almost 40% of the observations do not have bednet use reported, so we cannot throw out those observations and will instead use imputation to recreate those values.


```{r}
dat <- read.csv("gambiaMissing.csv")
dat$Y = factor(dat$Y)
dat$BEDNET = factor(dat$BEDNET)
dat$PHC = factor(dat$PHC)
summary(dat)
```


# Exploratory Data Analysis

```{r}
dat <- read.csv("gambiaMissing.csv")

bednet_group <- function(dat= NA, predictor = NA){
  bednet_group <- dat %>% 
                group_by_(predictor) %>% 
                summarize(BEDNET0 = mean(BEDNET==0 & !is.na(BEDNET)), 
                          BEDNET1 = mean(BEDNET==1 & !is.na(BEDNET)), 
                          BEDNETNA = mean(is.na(BEDNET))) %>%
                melt(id=predictor)
  return(bednet_group)
}

bednet_age <- bednet_group(dat, "AGE")
bednet_green <- bednet_group(dat, "GREEN")
bednet_phc <- bednet_group(dat, "PHC")
bednet_y <- bednet_group(dat, "Y")

ggplot(data=bednet_age, aes(x=as.factor(AGE), y=value, fill=variable)) + geom_col(position="dodge")
ggplot(data=bednet_green, aes(x=as.factor(GREEN), y=value+1E-10, fill=variable)) + geom_col(position="dodge")
ggplot(data=bednet_phc, aes(x=as.factor(PHC), y=value, fill=variable)) + geom_col(position="dodge")
ggplot(data=bednet_y, aes(x=as.factor(Y), y=value, fill=variable)) + geom_col(position="dodge")
```

There appears to be correlation between missingness in the bednet variable and the other predictors and the response.

# Test for Missingness Mechanism

```{r}
NArows <- which(is.na(dat$BEDNET))
dat$miss <- as.numeric(is.na(dat$BEDNET))

nullmod <- glm(miss ~ 1, family="binomial", data=dat)
fullmod <- glm(miss ~ AGE + GREEN + PHC, family="binomial", data=dat) #AGE and PHC appear to be "significant" predictors of missing BEDNET
(anova(nullmod, fullmod, test="Chisq"))
pchisq(fullmod$deviance, fullmod$df.residual,lower = FALSE)

```
Based on this test, the missingness mechanism is not completely at random. There is no way of knowing whether it is MAR or NMAR. 

# Discussion of Approaches

Since the data is not MCAR, we cannot use bootstrapping within the bednet variable. We will use chained regression to impute the missing values and calculate malaria prevalence. 

```{r}
temp <- mice(dat, m = 10, maxit = 35,method = c("", "", "logreg", "", "", ""), print = FALSE)
plot(temp)
densityplot(temp)

```

The trace lines appear to be stationary and free of trends, indicating convergence. We can see that the density distribution of each of the imputed datasets (in red) is congruent with the original one (in blue). 

```{r}
model1 = with(temp, glm(Y ~ AGE + GREEN + PHC+BEDNET, family="binomial"))
summary(pool(model1))
```

After fitting a logistic regression to each of the 10 generated datasets, we can see that the bednet variable is actually not significant.

# Contributions


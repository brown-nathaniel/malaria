---
title: "report1"
author: "Nathaniel Brown, Huijia Yu, Angie Shen"
date: "November 6, 2017"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)
library(reshape2)
library(ggplot2)
library(dplyr)
library(mice)
library(VIM)
```

# Introduction

We are interested in predicting whether malaria parasites will be found in a child's blood based on his/her age, bednet use, the amount of greenery in his/her village, and the presence of a health clinic. However, almost 40% of the observations do not have bednet use reported, so we cannot throw out those observations, and will instead impute those values to predict the outcome.


```{r}
dat <- read.csv("gambiaMissing.csv")
dat$Y = factor(dat$Y)
dat$BEDNET = factor(dat$BEDNET)
dat$PHC = factor(dat$PHC)
summary(dat)
```


# Exploratory Data Analysis

```{r}
dat <- read.csv("gambiaMissing.csv")

bednet_group <- function(dat= NA, predictor = NA){
  bednet_group <- dat %>% 
                group_by_(predictor) %>% 
                summarize(#BEDNET0 = mean(BEDNET==0 & !is.na(BEDNET)), 
                          #BEDNET1 = mean(BEDNET==1 & !is.na(BEDNET)), 
                          BEDNET01 = mean(!is.na(BEDNET)),
                          BEDNETNA = mean(is.na(BEDNET))) %>%
                melt(id=predictor)
  colnames(bednet_group) <- c("x", "missing", "y")
  return(bednet_group)
}

bednet_age <- bednet_group(dat, "AGE")
bednet_green <- bednet_group(dat, "GREEN")
bednet_phc <- bednet_group(dat, "PHC")
bednet_y <- bednet_group(dat, "Y")

ggplot(data=bednet_age, aes(x=as.factor(x), y=y, fill=missing)) + 
  geom_col(position="stack") + 
  labs(title="Age of Child by Missing Bednet",x="Age", y="Proportion", fill = "Missing") + 
  scale_fill_discrete(labels = c("not missing", "missing")) +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data=bednet_green, aes(x=as.factor(x), y=y, fill=missing)) +
  geom_col(position="stack") + 
  labs(title="Amout of Greenery by Missing Bednet",x="Green", y="Proportion", fill = "Missing") + 
  scale_fill_discrete(labels = c("not missing", "missing")) +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data=bednet_phc, aes(x=as.factor(x), y=y, fill=missing)) + 
  geom_col(position="stack") +   
  labs(title="Presence of Public Health Clinic by Missing Bednet",x="PHC", y="Proportion", fill = "Missing") + 
  scale_fill_discrete(labels = c("not missing", "missing")) +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data=bednet_y, aes(x=as.factor(x), y=y, fill=missing)) + 
  geom_col(position="stack") +   
  labs(title="Presence of Malaria Parasites by Missing Bednet",x="Malaria", y="Proportion", fill = "Missing") + 
  scale_fill_discrete(labels = c("not missing", "missing")) +
  theme(plot.title = element_text(hjust = 0.5))

```

There appears to be a relationship between missingness in the bednet variable and age. As Age increases, the proportion of missing bednet responses increases. The other predictor variables and the response do not have an obvious visible relationship with missing bednet. We will use logistic regression to formally test the null hypothesis that the bednet data is missing completely at random (MCAR) versus the alternative that it is missing at random (MAR).

# Test for Missingness Mechanism

**description of the three mechanisms**

```{r}
NArows <- which(is.na(dat$BEDNET))
dat$miss <- as.numeric(is.na(dat$BEDNET))

nullmod <- glm(miss ~ 1, family="binomial", data=dat)
fullmod <- glm(miss ~ AGE + GREEN + PHC, family="binomial", data=dat) #AGE and PHC appear to be "significant" predictors of missing BEDNET
(anova(nullmod, fullmod, test="Chisq"))
pchisq(fullmod$deviance, fullmod$df.residual,lower = FALSE)

```

Based on this test, the missingness mechanism is not MCAR. There is no way of knowing whether it is MAR or NMAR, but we will assume it is MAR. **why? can we just say "because it's more convenient?"**

# Discussion of Approaches

Since the data is not MCAR, we cannot use bootstrapping within the bednet variable. We will instead use chained regression using the MICE (Multivariate Imputation by Chained Equations) package to impute the missing values and calculate malaria prevalence. **explain what chained regression is**

```{r}
temp <- mice(dat, m = 10, maxit = 35,method = c("", "", "logreg", "", "", ""), print = FALSE)
summary(temp)
plot(temp)
densityplot(temp)

```

The trace lines appear to be stationary and free of trends, indicating convergence. We can see that the density distribution of each of the imputed datasets (in red) is congruent with the original one (in blue). 


```{r}
model1 = with(temp, glm(Y ~ AGE + GREEN + PHC+BEDNET, family="binomial"))
summary(pool(model1))
```

After fitting a logistic regression to each of the 10 generated datasets, we can see that the bednet variable is actually not significant.

# Contributions

Nathaniel made the Exploratory Data Analysis plots on the missingness of the bednet variable, and wrote the observations. Huijia worked on the Discussion of Approaches section.

---
title: "report1"
author: "Nathaniel Brown, Huijia Yu, Angie Shen"
date: "November 6, 2017"
output: pdf_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message=FALSE)
library(reshape2)
library(ggplot2)
library(dplyr)
library(mice)
library(VIM)
```

# Introduction

We are interested in predicting whether malaria parasites will be found in a child's blood based on his/her age, bednet use, the amount of greenery in his/her village, and the presence of a health clinic. However, almost 40% of the observations do not have bednet use reported, so we cannot throw out those observations, and will instead impute those values to predict the outcome.


```{r}
dat <- read.csv("gambiaMissing.csv")
dat$Y = factor(dat$Y)
dat$BEDNET = factor(dat$BEDNET)
dat$PHC = factor(dat$PHC)
summary(dat)
```


# Exploratory Data Analysis

```{r}
dat <- read.csv("gambiaMissing.csv")

bednet_group <- function(dat= NA, predictor = NA){
  bednet_group <- dat %>% 
                group_by_(predictor) %>% 
                summarize(#BEDNET0 = mean(BEDNET==0 & !is.na(BEDNET)), 
                          #BEDNET1 = mean(BEDNET==1 & !is.na(BEDNET)), 
                          BEDNET01 = mean(!is.na(BEDNET)),
                          BEDNETNA = mean(is.na(BEDNET))) %>%
                melt(id=predictor)
  colnames(bednet_group) <- c("x", "missing", "y")
  return(bednet_group)
}

bednet_age <- bednet_group(dat, "AGE")
bednet_green <- bednet_group(dat, "GREEN")
bednet_phc <- bednet_group(dat, "PHC")
bednet_y <- bednet_group(dat, "Y")

ggplot(data=bednet_age, aes(x=as.factor(x), y=y, fill=missing)) + 
  geom_col(position="stack") + 
  labs(title="Age of Child by Missing Bednet",x="Age", y="Proportion", fill = "Missing") + 
  scale_fill_discrete(labels = c("not missing", "missing")) +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data=bednet_green, aes(x=as.factor(x), y=y, fill=missing)) +
  geom_col(position="stack") + 
  labs(title="Amout of Greenery by Missing Bednet",x="Green", y="Proportion", fill = "Missing") + 
  scale_fill_discrete(labels = c("not missing", "missing")) +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data=bednet_phc, aes(x=as.factor(x), y=y, fill=missing)) + 
  geom_col(position="stack") +   
  labs(title="Presence of Public Health Clinic by Missing Bednet",x="PHC", y="Proportion", fill = "Missing") + 
  scale_fill_discrete(labels = c("not missing", "missing")) +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data=bednet_y, aes(x=as.factor(x), y=y, fill=missing)) + 
  geom_col(position="stack") +   
  labs(title="Presence of Malaria Parasites by Missing Bednet",x="Malaria", y="Proportion", fill = "Missing") + 
  scale_fill_discrete(labels = c("not missing", "missing")) +
  theme(plot.title = element_text(hjust = 0.5))

```

There appears to be a relationship between missingness in the bednet variable and age. As Age increases, the proportion of missing bednet responses increases. The other predictor variables and the response do not have an obvious visible relationship with missing bednet. We will use logistic regression to formally test the null hypothesis that the bednet data is missing completely at random (MCAR) versus the alternative that it is missing at random (MAR).

# Test for Missingness Mechanism

**description of the three mechanisms**

```{r}
NArows <- which(is.na(dat$BEDNET))
dat$miss <- as.numeric(is.na(dat$BEDNET))

nullmod <- glm(miss ~ 1, family="binomial", data=dat)
fullmod <- glm(miss ~ AGE + GREEN + PHC, family="binomial", data=dat) #AGE and PHC appear to be "significant" predictors of missing BEDNET
(anova(nullmod, fullmod, test="Chisq"))
pchisq(fullmod$deviance, fullmod$df.residual,lower = FALSE)

```

Based on this test, the missingness mechanism is not MCAR. Therefore, we will assume it is MAR. **why? can we just say "because it's more convenient?"**

# Discussion of Approaches

Since the data is not MCAR, we cannot use bootstrapping within the bednet variable. We will instead use chained regression using the MICE (Multivariate Imputation by Chained Equations) package to impute the missing values and calculate malaria prevalence. **explain what chained regression is**

```{r}
temp <- mice(dat, method = c("", "", "logreg", "", "", ""), print = FALSE)
summary(temp)
ggplot(data=complete(temp), aes(x=AGE)) + geom_bar(aes(fill=as.factor(BEDNET)), position="dodge")
densityPlot(temp)
summary(complete(temp))
```

# Contributions

Nathaniel made the Exploratory Data Analysis plots on the missingess of the bednet variable, and wrote the observations.

<!--
Mice stuff 

 ```{r}
 data <- read.table("kellydat.txt", header=T)
 data$race = 0
 data$race[data$black==1|data$hisp==1] = 1
 data$sn0 = 0
 data$sn0[data$sn1==0 & data$sn2==0 & data$sn3==0 & data$all4==0] = 1
 
 data.imp = data
 data.imp$nctdel[data.imp$fail == 0] = NA
 
 #md.pattern(data.imp[!is.na(data.imp$nctdel),])
 
 tempData <- mice(data.imp,m=5,maxit=50,meth='pmm',seed=500, print=FALSE)
 # methods: 
 # 2l.norm / 2l.pan / 2lonly.mean / 2lonly.norm / 2lonly.pmm / 
 # cart / fastpmm / lda / logreg / logreg.boot / mean / midastouch / norm / norm.boot / norm.nob / 
 # norm.predict / passive / pmm / polr / polyreg / quadratic / rf / ri / sample
 
 #tempData$imp$nctdel
 
 data.imp <- complete(tempData)
 
 hist(log(data.imp$nctdel + 0.1))
 
 fit <-lm(log(nctdel+0.1) ~ sn0 + sn1 + sn2 + race + male, data = data)
 ```
 
 ##Diagnostic 
 
 
 
 
 
 
 
 ```{r}
 library(VIM)
 library(mice)
 
 
 ##looking for pattern of missing data
 md.pattern(data.imp)
 
 #visualizations: 
 aggr_plot <- aggr(data, col=c('navyblue','red'), numbers=TRUE, sortVars=TRUE, labels=names(data), cex.axis=.7, gap=3, ylab=c("Histogram of missing data","Pattern"))
 
 marginplot(data.imp[c(1,2)])
 marginplot(data[c(1,3)])
 marginplot(data[c(1,4)])
 marginplot(data[c(1,5)])
 marginplot(data[c(1,6)])
 marginplot(data[c(1,7)])
 marginplot(data[c(1,8)])
 marginplot(data[c(1,9)])
 marginplot(data[c(1,10)])
 
 
 
 #visualize distribution of original and imputed data- check if imputed data is lausible
 
 #xyplot(tempData,nctdel ~ fail+male+black,pch=18,cex=1)  
 
 #densityplot(tempData)
 
#stripplot(data, pch = 20, cex = 1.2)
```
-->